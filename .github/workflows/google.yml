name: 'Build and Push to Artifact Registry'

on:
  push:
    branches:
      - 'main'
      - 'qa'

env:
  PROJECT_ID: '${{ env.PROJECT_ID }}'
  GAR_LOCATION: '${{ env.GAR_LOCATION }}'
  REPOSITORY: '${{ env.REPOSITORY }}'
  IMAGE: 'static-site'

jobs:
  setup-build-publish:
    name: 'Setup, Build, and Publish to Artifact Registry'
    runs-on: 'ubuntu-latest'
    environment: 'production'

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@v2'

      # Configure Workload Identity Federation and generate an access token.
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ env.WORKLOAD_IDENTITY_PROVIDER }}'

      # Authenticate Docker to Google Cloud Artifact Registry
      - name: 'Docker Auth'
        uses: 'docker/login-action@v2'
        with:
          username: 'oauth2accesstoken'
          password: '${{ steps.auth.outputs.auth_token }}'
          registry: '${{ env.GAR_LOCATION }}-docker.pkg.dev'

      # Set environment variables based on the branch (main or qa)
      - name: 'Set branch-specific environment variables'
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            echo "BRANCH=main" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF}" == "refs/heads/qa" ]]; then
            echo "BRANCH=qa" >> $GITHUB_ENV
          fi

      # Build the Docker image
      - name: 'Build and push Docker container'
        run: |-
          DOCKER_TAG="${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${IMAGE}:${GITHUB_SHA}-${{ env.BRANCH }}"

          docker build \
            --tag "${DOCKER_TAG}" \
            --build-arg GITHUB_SHA="${GITHUB_SHA}" \
            --build-arg GITHUB_REF="${GITHUB_REF}" \
            .

          docker push "${DOCKER_TAG}"
